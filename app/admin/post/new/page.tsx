/**
 * ìƒˆ ê²Œì‹œë¬¼ ì‘ì„± í˜ì´ì§€
 * PostForm ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ê²Œì‹œë¬¼ ì‘ì„± ê¸°ëŠ¥ ì œê³µ
 */

'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from '@clerk/nextjs'
import PostForm from '@/components/admin/post-form'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { ArrowLeft, FileText, Lock } from 'lucide-react'

/**
 * ê²Œì‹œë¬¼ í¼ ë°ì´í„° íƒ€ì… (PostFormê³¼ ë™ì¼)
 */
interface PostFormData {
  title: string
  content: string
  slug: string
  coverImageUrl: string
  categoryId: string
}

export default function NewPostPage() {
  const router = useRouter()
  const { isSignedIn, isLoaded } = useAuth()
  const [isLoading, setIsLoading] = useState(false)

  // ì¸ì¦ ë¡œë”© ì¤‘
  if (!isLoaded) {
    return (
      <div className="container mx-auto px-4 py-8">
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p className="text-gray-600">ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
          </div>
        </div>
      </div>
    )
  }

  // ë¯¸ì¸ì¦ ì‚¬ìš©ì ì ‘ê·¼ ì°¨ë‹¨
  if (!isSignedIn) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-md mx-auto bg-red-50 border-red-200">
          <CardHeader>
            <CardTitle className="text-red-800 flex items-center gap-2">
              <Lock className="w-5 h-5" />
              ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤
            </CardTitle>
          </CardHeader>
          <CardContent className="text-red-700">
            <p className="mb-4">ê²Œì‹œë¬¼ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <Button 
              onClick={() => router.push('/sign-in')}
              className="w-full"
            >
              ë¡œê·¸ì¸í•˜ê¸°
            </Button>
          </CardContent>
        </Card>
      </div>
    )
  }

  /**
   * í¼ ì œì¶œ í•¸ë“¤ëŸ¬
   */
  const handleSubmit = async (data: PostFormData) => {
    setIsLoading(true)
    
    try {
      console.log('=== ìƒˆ ê²Œì‹œë¬¼ ìƒì„± ìš”ì²­ ===')
      console.log('API ì—”ë“œí¬ì¸íŠ¸: POST /api/posts')
      console.log('ìš”ì²­ ë°ì´í„°:', data)
      
      // ì‹¤ì œ API í˜¸ì¶œ
      const response = await fetch('/api/posts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: data.title,
          content: data.content,
          slug: data.slug,
          cover_image_url: data.coverImageUrl || null,
          category_id: data.categoryId === 'none' ? null : data.categoryId
        }),
      })

      if (!response.ok) {
        const errorData = await response.json()
        throw new Error(errorData.error || 'ê²Œì‹œë¬¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')
      }

      const result = await response.json()
      console.log('âœ… ê²Œì‹œë¬¼ ìƒì„± ì„±ê³µ:', result)
      
      // ì„±ê³µ ì‹œ ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
      router.push(`/posts/${data.slug}`)
      
    } catch (error) {
      console.error('âŒ ê²Œì‹œë¬¼ ìƒì„± ì‹¤íŒ¨:', error)
      alert(error instanceof Error ? error.message : 'ê²Œì‹œë¬¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')
      throw error
    } finally {
      setIsLoading(false)
    }
  }

  /**
   * ì·¨ì†Œ í•¸ë“¤ëŸ¬
   */
  const handleCancel = () => {
    if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      router.back()
    }
  }

  /**
   * ë’¤ë¡œ ê°€ê¸° í•¸ë“¤ëŸ¬
   */
  const handleGoBack = () => {
    router.back()
  }

  return (
    <div className="container mx-auto px-4 py-8">
      {/* í˜ì´ì§€ í—¤ë” */}
      <div className="mb-8">
        <div className="flex items-center gap-4 mb-4">
          <Button
            variant="outline"
            size="sm"
            onClick={handleGoBack}
            className="flex items-center gap-2"
          >
            <ArrowLeft className="w-4 h-4" />
            ë’¤ë¡œ ê°€ê¸°
          </Button>
        </div>
        
        <div className="flex items-center gap-3">
          <FileText className="w-8 h-8 text-blue-600" />
          <div>
            <h1 className="text-3xl font-bold text-gray-900">
              ìƒˆ ê²Œì‹œë¬¼ ì‘ì„±
            </h1>
            <p className="text-gray-600 mt-1">
              ë¸”ë¡œê·¸ì— ìƒˆë¡œìš´ ê²Œì‹œë¬¼ì„ ì‘ì„±í•´ë³´ì„¸ìš”.
            </p>
          </div>
        </div>
      </div>

      {/* ì•ˆë‚´ ì¹´ë“œ */}
      <Card className="mb-8 bg-blue-50 border-blue-200">
        <CardHeader>
          <CardTitle className="text-blue-800 text-lg">
            ğŸ“ ê²Œì‹œë¬¼ ì‘ì„± ê°€ì´ë“œ
          </CardTitle>
        </CardHeader>
        <CardContent className="text-blue-700">
          <ul className="space-y-2 text-sm">
            <li>â€¢ <strong>ì œëª©</strong>: ë…ìì˜ ê´€ì‹¬ì„ ëŒ ìˆ˜ ìˆëŠ” ëª…í™•í•œ ì œëª©ì„ ì‘ì„±í•˜ì„¸ìš”</li>
            <li>â€¢ <strong>URL ìŠ¬ëŸ¬ê·¸</strong>: ì œëª©ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</li>
            <li>â€¢ <strong>ì»¤ë²„ ì´ë¯¸ì§€</strong>: ê²Œì‹œë¬¼ì„ ëŒ€í‘œí•˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (ì„ íƒì‚¬í•­)</li>
            <li>â€¢ <strong>ì¹´í…Œê³ ë¦¬</strong>: ê²Œì‹œë¬¼ì˜ ì£¼ì œì— ë§ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</li>
            <li>â€¢ <strong>ë‚´ìš©</strong>: ìµœì†Œ 10ê¸€ì ì´ìƒì˜ ì˜ë¯¸ ìˆëŠ” ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”</li>
          </ul>
        </CardContent>
      </Card>

      {/* ê²Œì‹œë¬¼ ì‘ì„± í¼ */}
      <PostForm
        onSubmit={handleSubmit}
        onCancel={handleCancel}
        isLoading={isLoading}
        className="mb-8"
      />

      {/* ê°œë°œì ì •ë³´ */}
      <Card className="bg-green-50 border-green-200">
        <CardHeader>
          <CardTitle className="text-green-800 text-sm">
            âœ… ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì™„ë£Œ
          </CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-green-700">
          <div className="space-y-2">
            <p><strong>í˜„ì¬ ìƒíƒœ:</strong> ì‹¤ì œ Supabase ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™</p>
            <p><strong>ê¸°ëŠ¥:</strong> ê²Œì‹œë¬¼ ì‘ì„±, ì´ë¯¸ì§€ ì—…ë¡œë“œ, ì¹´í…Œê³ ë¦¬ ì„ íƒ</p>
            <p><strong>ì €ì¥ ìœ„ì¹˜:</strong> Supabase posts í…Œì´ë¸”</p>
            <p><strong>ì„±ê³µ ì‹œ:</strong> ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€ë¡œ ìë™ ì´ë™</p>
            <p><strong>í™•ì¸ ë°©ë²•:</strong> ì €ì¥ í›„ í™ˆí˜ì´ì§€ë‚˜ ê²Œì‹œë¬¼ ëª©ë¡ì—ì„œ ìƒˆ ê²Œì‹œë¬¼ í™•ì¸</p>
          </div>
        </CardContent>
      </Card>
    </div>
  )
} 